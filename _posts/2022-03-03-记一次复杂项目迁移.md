---
title: 记一次复杂项目迁移
date: 2022-03-03 08:54:22
tags: 运维
---
## 网络环境
新的服务器与老的服务器网段不同，只能单向访问老服务器，且无法本地访问，需通过堡垒机运维，此为前提。
## 环境安装
涉及到java、maven基本环境安装，maven主要用来打包程序，git拉下来方便在线部署；docker安装，用于安装一些中间件mysql、redis、elasticSearch、fastDFS。具体安装部署会在下一篇文章总结。

## 文件迁移
项目1的文件存储在公司公共的fastDFS库，迁移方案主要有方案1:`采用节点扩容`,由于网络不通，放弃；方案2:`直接拷贝`，让运维看了下19G，拷完不知道猴年马月了，而且项目中所占只有1G左右，放弃；最后想了一个偏路子，写代码获取库里的文件地址，下载然后上传到新部署的fdfs，再update库里的地址。过程有一点波折，有些业务表里存的直接是地址，需要再找出来替换掉。

项目2的文件存储在远古的ftp上，写了代码按照地址路径下载所有文件，然后在老服务器上压缩，大小达到9个G，但是新服务器可以访问到,到底是内网速度飞快100M/s，通过代码的下载接口直接在新服务器上下好然后解压。代码改造下，原先本地开发的就是直接文件存储没有上文件服务器，老代码掏出来改改直接上传下载齐活。


## 代码部署
前端nginx配下，后端jar包启动，调整下端口,然后申请开通域名映射，一系列接口白名单等等，齐活。

## 问题解决
1.mysql大小写问题，docker创建的时候就要给mysql设置好。

2.springboot jar包启动缓慢，一开始很正常，后来改过防火墙，每次都要2分钟左右。排查以为是随机值问题，修改无果。最后排查到mysql连接过慢，可能是防火墙重启导致docker安装的东西有问题，重启docker，重启mysql。代码可以正常快速启动好。