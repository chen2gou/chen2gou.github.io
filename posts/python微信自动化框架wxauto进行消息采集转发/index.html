<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="python微信自动化框架wxauto进行消息采集转发" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="需求 采集大群中含关键词的聊天记录，并进行自定义消息处理「脱敏、添加」，然后转发至指定群聊；同时存储信息至redis key为当天日期的set，判重发送 定时任务，每天定时发送公告，公告文件为txt" /><meta property="og:description" content="需求 采集大群中含关键词的聊天记录，并进行自定义消息处理「脱敏、添加」，然后转发至指定群聊；同时存储信息至redis key为当天日期的set，判重发送 定时任务，每天定时发送公告，公告文件为txt" /><link rel="canonical" href="/posts/python%E5%BE%AE%E4%BF%A1%E8%87%AA%E5%8A%A8%E5%8C%96%E6%A1%86%E6%9E%B6wxauto%E8%BF%9B%E8%A1%8C%E6%B6%88%E6%81%AF%E9%87%87%E9%9B%86%E8%BD%AC%E5%8F%91/" /><meta property="og:url" content="/posts/python%E5%BE%AE%E4%BF%A1%E8%87%AA%E5%8A%A8%E5%8C%96%E6%A1%86%E6%9E%B6wxauto%E8%BF%9B%E8%A1%8C%E6%B6%88%E6%81%AF%E9%87%87%E9%9B%86%E8%BD%AC%E5%8F%91/" /><meta property="og:site_name" content="爱喝馄饨的小陈" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-03-07T16:07:37+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="python微信自动化框架wxauto进行消息采集转发" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-04-11T11:59:55+08:00","datePublished":"2024-03-07T16:07:37+08:00","description":"需求 采集大群中含关键词的聊天记录，并进行自定义消息处理「脱敏、添加」，然后转发至指定群聊；同时存储信息至redis key为当天日期的set，判重发送 定时任务，每天定时发送公告，公告文件为txt","headline":"python微信自动化框架wxauto进行消息采集转发","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/python%E5%BE%AE%E4%BF%A1%E8%87%AA%E5%8A%A8%E5%8C%96%E6%A1%86%E6%9E%B6wxauto%E8%BF%9B%E8%A1%8C%E6%B6%88%E6%81%AF%E9%87%87%E9%9B%86%E8%BD%AC%E5%8F%91/"},"url":"/posts/python%E5%BE%AE%E4%BF%A1%E8%87%AA%E5%8A%A8%E5%8C%96%E6%A1%86%E6%9E%B6wxauto%E8%BF%9B%E8%A1%8C%E6%B6%88%E6%81%AF%E9%87%87%E9%9B%86%E8%BD%AC%E5%8F%91/"}</script><title>python微信自动化框架wxauto进行消息采集转发 | 爱喝馄饨的小陈</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="爱喝馄饨的小陈"><meta name="application-name" content="爱喝馄饨的小陈"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /img/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">爱喝馄饨的小陈</a></div><div class="site-subtitle font-italic">偷懒是第一生产力</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/github_username" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['jbhay','foxmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>python微信自动化框架wxauto进行消息采集转发</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>python微信自动化框架wxauto进行消息采集转发</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://twitter.com/username">chengao</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1709798857" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-03-07 </em> </span> <span> 更新于 <em class="timeago" data-ts="1712807995" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-04-11 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1013 字"> <em>5 分钟</em>阅读</span></div></div></div><div class="post-content"><h2 id="需求"><span class="mr-2">需求</span><a href="#需求" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>采集大群中含关键词的聊天记录，并进行自定义消息处理「脱敏、添加」，然后转发至指定群聊；同时存储信息至redis key为当天日期的set，判重发送<li>定时任务，每天定时发送公告，公告文件为txt</ul><h2 id="环境"><span class="mr-2">环境</span><a href="#环境" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>微信版本: <strong>3.9.8.15</strong></p><p>python版本: <strong>3.11.6</strong></p><p>wxauto版本: <strong>3.9.8</strong></p><p>服务器版本: <strong>阿里云 2核4g windows 2012</strong></p><h2 id="源码"><span class="mr-2">源码</span><a href="#源码" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">wxauto</span> <span class="kn">import</span> <span class="n">WeChat</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">schedule</span>

<span class="c1"># 实例化微信对象
</span><span class="n">wx</span> <span class="o">=</span> <span class="n">WeChat</span><span class="p">()</span>

<span class="n">listen_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'采集群1'</span>
<span class="p">]</span>
<span class="c1"># 转发目标群
</span><span class="n">target_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1">#'test',
</span><span class="p">]</span>

<span class="c1"># 文末信息
</span><span class="n">end_text</span> <span class="o">=</span> <span class="s">"接单请联系群主 📞1234567890"</span>

<span class="n">pool</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">ConnectionPool</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">listen_group_chat</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">listen_list</span><span class="p">:</span>
        <span class="n">wx</span><span class="p">.</span><span class="n">AddListenChat</span><span class="p">(</span><span class="n">who</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">savepic</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>  <span class="c1"># 添加监听对象并且自动保存新消息图片
</span>
    <span class="c1"># 持续监听消息
</span>    <span class="n">wait</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># 设置10秒查看一次是否有新消息
</span>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">msgs</span> <span class="o">=</span> <span class="n">wx</span><span class="p">.</span><span class="n">GetListenMessage</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'采集时间：</span><span class="si">{</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y-%m-%d %H:%M:%S"</span><span class="p">)</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chat</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msgs</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">chat</span><span class="p">)</span>  <span class="c1"># 获取消息内容
</span>            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="se">\n</span><span class="s">-----&gt;已获取新的消息,采集源：</span><span class="si">{</span><span class="n">chat</span><span class="p">.</span><span class="n">who</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
            <span class="c1"># 获取每条聊天信息
</span>            <span class="k">for</span> <span class="n">msg_item</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="c1"># 判断是否包含关键词
</span>                <span class="n">msg_content</span> <span class="o">=</span> <span class="n">msg_item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'消息内容:</span><span class="si">{</span><span class="n">msg_item</span><span class="si">}</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">keyword_match</span><span class="p">(</span><span class="n">msg_content</span><span class="p">):</span>
                    <span class="c1"># 判断redis中是否存在
</span>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_value</span><span class="p">(</span><span class="n">msg_content</span><span class="p">):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">"开始自定义消息处理"</span><span class="p">)</span>
                        <span class="c1"># 消息脱敏处理
</span>                        <span class="n">cleaned_text</span> <span class="o">=</span> <span class="n">msg_handler</span><span class="p">(</span><span class="n">msg_content</span><span class="p">)</span>
                        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"处理结果:</span><span class="si">{</span><span class="n">cleaned_text</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                        <span class="c1"># 转发至其他群
</span>                        <span class="n">trans_to_another_group</span><span class="p">(</span><span class="n">target_list</span><span class="p">,</span> <span class="n">cleaned_text</span><span class="p">)</span>
                        <span class="c1"># redis缓存
</span>                        <span class="n">set_cache</span><span class="p">(</span><span class="n">msg_content</span><span class="p">)</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">"-----&gt;消息已缓存,处理结束</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">"-----&gt;当日消息已存在， 不作处理</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">"-----&gt;消息不包含关键词， 不作处理</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">schedule</span><span class="p">.</span><span class="n">run_pending</span><span class="p">()</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>


<span class="c1"># 转发至其他群
</span><span class="k">def</span> <span class="nf">trans_to_another_group</span><span class="p">(</span><span class="n">group_names</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"即将开始消息转发"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">group_name</span> <span class="ow">in</span> <span class="n">group_names</span><span class="p">:</span>
        <span class="n">wx</span><span class="p">.</span><span class="n">ChatWith</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">at</span><span class="p">:</span>
            <span class="n">wx</span><span class="p">.</span><span class="n">AtSomeOne</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wx</span><span class="p">.</span><span class="n">SendMsg</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"消息已转发至</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>


<span class="c1"># 消息处理器
</span><span class="k">def</span> <span class="nf">msg_handler</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="c1"># 去除原有手机号
</span>    <span class="n">phone_pattern</span> <span class="o">=</span> <span class="s">"1[3-9]\d{9}"</span>
    <span class="n">cleaned_text</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">phone_pattern</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">cleaned_text</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">end_text</span><span class="si">}</span><span class="s">'</span>


<span class="c1"># 关键词匹配
</span><span class="k">def</span> <span class="nf">keyword_match</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="c1"># 定义要匹配的关键词列表
</span>    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s">"key1"</span><span class="p">,</span> <span class="s">"key2"</span><span class="p">,</span> <span class="s">"key3"</span><span class="p">]</span>
    <span class="n">xiaoqu_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s">'area1'</span><span class="p">,</span> <span class="s">'area2'</span><span class="p">,</span> <span class="s">'area3'</span><span class="p">]</span>
    <span class="c1"># 构建正则表达式
</span>    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s">'|'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">re</span><span class="p">.</span><span class="n">escape</span><span class="p">,</span> <span class="n">keywords</span> <span class="o">+</span> <span class="n">xiaoqu_keywords</span><span class="p">))</span>
    <span class="c1"># 进行匹配并输出结果
</span>    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>


<span class="c1"># md5加密
</span><span class="k">def</span> <span class="nf">md5_encode</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">md5</span><span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>  <span class="c1"># 创建md5对象
</span>    <span class="n">md5pwd</span> <span class="o">=</span> <span class="n">md</span><span class="p">.</span><span class="n">hexdigest</span><span class="p">()</span>  <span class="c1"># md5加密
</span>    <span class="k">return</span> <span class="n">md5pwd</span>


<span class="c1"># redis set赋值 过期默认24小时
</span><span class="k">def</span> <span class="nf">set_cache</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">connection_pool</span><span class="o">=</span><span class="n">pool</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y%m%d"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="c1"># 判断redis中set值是否存在
</span><span class="k">def</span> <span class="nf">check_value</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y%m%d"</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">connection_pool</span><span class="o">=</span><span class="n">pool</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">.</span><span class="n">sismember</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>


<span class="c1"># 广告播报
</span><span class="k">def</span> <span class="nf">notice_broadcast</span><span class="p">():</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="s">'notice1.txt'</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 打开文件并读取所有行（包括换行符）
</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s">'r'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">trans_to_another_group</span><span class="p">(</span><span class="n">target_list</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"未找到该文件"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"发生错误: "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">schedule_init</span><span class="p">():</span>
    <span class="c1"># 清空任务
</span>    <span class="n">schedule</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="c1"># 创建一个按3秒间隔执行任务
</span>    <span class="n">schedule</span><span class="p">.</span><span class="n">every</span><span class="p">().</span><span class="n">day</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">"06:00"</span><span class="p">).</span><span class="n">do</span><span class="p">(</span><span class="n">notice_broadcast</span><span class="p">)</span>
    <span class="n">schedule</span><span class="p">.</span><span class="n">every</span><span class="p">().</span><span class="n">day</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">"12:00"</span><span class="p">).</span><span class="n">do</span><span class="p">(</span><span class="n">notice_broadcast</span><span class="p">)</span>
    <span class="n">schedule</span><span class="p">.</span><span class="n">every</span><span class="p">().</span><span class="n">day</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">"18:00"</span><span class="p">).</span><span class="n">do</span><span class="p">(</span><span class="n">notice_broadcast</span><span class="p">)</span>
    <span class="n">schedule</span><span class="p">.</span><span class="n">every</span><span class="p">().</span><span class="n">day</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">"21:00"</span><span class="p">).</span><span class="n">do</span><span class="p">(</span><span class="n">notice_broadcast</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="c1">#需要注意 开启定时任务需要在监视循环内 并且初始化有先后顺序
</span>    <span class="n">schedule_init</span><span class="p">()</span>
    <span class="n">listen_group_chat</span><span class="p">()</span>

</pre></table></code></div></div><h2 id="效果图"><span class="mr-2">效果图</span><a href="#效果图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/img/2024/03/xiaoguotu.png" alt="" data-proofer-ignore></p><h2 id="待优化"><span class="mr-2">待优化</span><a href="#待优化" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>日志文件输出<li>记录入库<li>公告在线发布</ul><h2 id="常见问题"><span class="mr-2">常见问题</span><a href="#常见问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>报错 一般是python版本号问题<li>此工具需要保持远程连接，前台运行hook，windows自带工具不可用，本人使用todesk，其他软件自行搜索<li>远程桌面亦可，不过需要断开连接使用脚本保证不退出桌面，新建 exit.bat，每次点击脚本退出 ``` exit.bat @echo off for %%i in (0,1,2,3,4,5,6,7,8,9) do (tscon %%i /dest:console )</ul><p>```</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/%E5%BE%AE%E4%BF%A1%E8%87%AA%E5%8A%A8%E5%8C%96/" class="post-tag no-text-decoration" >微信自动化</a> <a href="/tags/wxauto/" class="post-tag no-text-decoration" >wxauto</a> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=python微信自动化框架wxauto进行消息采集转发 - 爱喝馄饨的小陈&amp;url=/posts/python%E5%BE%AE%E4%BF%A1%E8%87%AA%E5%8A%A8%E5%8C%96%E6%A1%86%E6%9E%B6wxauto%E8%BF%9B%E8%A1%8C%E6%B6%88%E6%81%AF%E9%87%87%E9%9B%86%E8%BD%AC%E5%8F%91/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=python微信自动化框架wxauto进行消息采集转发 - 爱喝馄饨的小陈&amp;u=/posts/python%E5%BE%AE%E4%BF%A1%E8%87%AA%E5%8A%A8%E5%8C%96%E6%A1%86%E6%9E%B6wxauto%E8%BF%9B%E8%A1%8C%E6%B6%88%E6%81%AF%E9%87%87%E9%9B%86%E8%BD%AC%E5%8F%91/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=/posts/python%E5%BE%AE%E4%BF%A1%E8%87%AA%E5%8A%A8%E5%8C%96%E6%A1%86%E6%9E%B6wxauto%E8%BF%9B%E8%A1%8C%E6%B6%88%E6%81%AF%E9%87%87%E9%9B%86%E8%BD%AC%E5%8F%91/&amp;text=python微信自动化框架wxauto进行消息采集转发 - 爱喝馄饨的小陈" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/python%E5%BE%AE%E4%BF%A1%E8%87%AA%E5%8A%A8%E5%8C%96%E6%A1%86%E6%9E%B6wxauto%E8%BF%9B%E8%A1%8C%E6%B6%88%E6%81%AF%E9%87%87%E9%9B%86%E8%BD%AC%E5%8F%91/">python微信自动化框架wxauto进行消息采集转发</a><li><a href="/posts/docker%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E5%B8%B8%E8%A7%81%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%83%A8%E7%BD%B2/">docker环境安装以及常见中间件部署</a><li><a href="/posts/kkFileView%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%BC%98%E9%9B%85%E9%A2%84%E8%A7%88%E6%B0%B4%E5%8D%B0/">kkFileView实现文件优雅预览水印</a><li><a href="/posts/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-oauth2%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B/">【源码分析】springsecurity oauth2认证流程</a><li><a href="/posts/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-springsecurity%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F%E5%A6%82%E4%BD%95%E6%A0%A1%E9%AA%8C%E5%AF%86%E7%A0%81/">【源码分析】springsecurity密码模式校验密码</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E8%BF%90%E7%BB%B4/">运维</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/oauth2/">oauth2</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/springsecurity/">springsecurity</a> <a class="post-tag" href="/tags/mac/">mac</a> <a class="post-tag" href="/tags/mysql/">mysql</a> <a class="post-tag" href="/tags/python/">python</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/%E5%8F%88%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%8D%E6%9D%82%E9%A1%B9%E7%9B%AE%E8%BF%81%E7%A7%BB/"><div class="card-body"> <em class="timeago small" data-ts="1718209245" > 2024-06-13 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>又记一次复杂项目迁移</h3><div class="text-muted small"><p> 前言 是的，项目迁移它又来了，还是22年那个项目，不同的是公司上了devops，所有组件都容器化了，免去了安装的过程，但是文件还得迁移那，又是罪恶滔天的fdfs，文件存的很凌乱，有的在富文本里有的在结构化数据库里，但不同的是我学会了python，py真的天下第一,太方便了家人们。这次解决问题的思路如下: 导出全量sql python正则选取文件url [re] 下载再上传 [r...</p></div></div></a></div><div class="card"> <a href="/posts/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-logback%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE%E5%8F%8A%E5%AD%98%E5%82%A8/"><div class="card-body"> <em class="timeago small" data-ts="1712805127" > 2024-04-11 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>【源码分析】logback日志配置及存储</h3><div class="text-muted small"><p> 起因 linux系统中springboot日志文件默认存在/tmp下，那么为什么会存储在这个位置呢,查阅可知 org/springframework/boot/logging/logback/base.xml 进行了相关定义 同时查看logback日志配置文件会有疑问，有些变量取自于defauts.xml中自定义，这些日志中的变量到底哪里来的呢。 源...</p></div></div></a></div><div class="card"> <a href="/posts/%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7%E4%B9%8Boauth2%E5%88%A9%E7%94%A8state%E4%BC%A0%E5%8F%82/"><div class="card-body"> <em class="timeago small" data-ts="1692691945" > 2023-08-22 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>奇技淫巧之oauth2利用state传参</h3><div class="text-muted small"><p> 问题 公司多个子系统调用同一套oauth2认证，但是系统之间token是自定义的，现在需要A跳转到B指定页面，单点认证之后跳转的地址是固定的 解决办法 利用oauth2中的state参数，oauth官网上有这样一段 关于state描述的内容 如果客户端希望在重定向 URL 中包含特定于请求的数据，则可以使用“state”参数来存储用户重定向后将包含的数据。 它可以对状态参数本身中的数据进...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7%E4%B9%8Boauth2%E5%88%A9%E7%94%A8state%E4%BC%A0%E5%8F%82/" class="btn btn-outline-primary" prompt="上一篇"><p>奇技淫巧之oauth2利用state传参</p></a> <a href="/posts/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-logback%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE%E5%8F%8A%E5%AD%98%E5%82%A8/" class="btn btn-outline-primary" prompt="下一篇"><p>【源码分析】logback日志配置及存储</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "chen2gou/chen2gou.github.io", "data-repo-id": "R_kgDOG2L1lQ", "data-category": "General", "data-category-id": "DIC_kwDOG2L1lc4CBLyx", "data-mapping": "title", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "bottom", "data-lang": "zh-CN", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/username">chengao</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E8%BF%90%E7%BB%B4/">运维</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/oauth2/">oauth2</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/springsecurity/">springsecurity</a> <a class="post-tag" href="/tags/mac/">mac</a> <a class="post-tag" href="/tags/mysql/">mysql</a> <a class="post-tag" href="/tags/python/">python</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
